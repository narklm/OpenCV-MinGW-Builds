name: Auto Build OpenCV MinGW Release

on:
  schedule:
    - cron: "0 20 * * 1"   # 每天4:00（北京时间）检查更新
  workflow_dispatch:       # 可手动触发

jobs:
  check-and-build:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest OpenCV version tag
        id: get_tag
        run: |
          $latest = (Invoke-RestMethod https://api.github.com/repos/opencv/opencv/releases/latest).tag_name
          echo "latest=$latest" >> $env:GITHUB_OUTPUT

      - name: Check if release already exists
        id: check_release
        run: |
          $tag = "${{ steps.get_tag.outputs.latest }}"
          $releases = Invoke-RestMethod "https://api.github.com/repos/${{ github.repository }}/releases"
          $exists = $releases | Where-Object { $_.tag_name -eq $tag }
          if ($exists) {
            echo "Release $tag already exists. Skipping build."
            echo "skip=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "New OpenCV version $tag found. Building..."
            echo "skip=false" >> $env:GITHUB_OUTPUT
          }

      - name: Stop if release exists
        if: steps.check_release.outputs.skip == 'true'
        run: echo "No new version to build."

      - name: Install MinGW and CMake
        if: steps.check_release.outputs.skip == 'false'
        run: |
          choco install mingw -y
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=1' -y
          g++ --version
          cmake --version

      - name: Download specific OpenCV tag
        if: steps.check_release.outputs.skip == 'false'
        run: |
          $tag = "${{ steps.get_tag.outputs.latest }}"
          git clone --depth=1 --branch $tag https://github.com/opencv/opencv.git
          git clone --depth=1 --branch $tag https://github.com/opencv/opencv_contrib.git

      - name: Configure & Build OpenCV (MinGW)
        if: steps.check_release.outputs.skip == 'false'
        run: |
          mkdir build_opencv
          cd build_opencv
          cmake -G "MinGW Makefiles" `
                -DCMAKE_BUILD_TYPE=Release `
                -DCMAKE_INSTALL_PREFIX=install `
                -DBUILD_SHARED_LIBS=OFF `
                -DBUILD_EXAMPLES=OFF `
                -DBUILD_opencv_world=ON `
                -DCPU_DISPATCH="" `
                -DWITH_OPENGL=ON `
                -DBUILD_DOCS=OFF `
                -DOPENCV_EXTRA_MODULES_PATH=../opencv_contrib/modules `
                ../opencv
          mingw32-make -j4
          mingw32-make install

      - name: Compress build result
        if: steps.check_release.outputs.skip == 'false'
        run: |
          cd build_opencv
          powershell Compress-Archive -Path install -DestinationPath opencv-mingw.zip

      - name: Create GitHub Release
        if: steps.check_release.outputs.skip == 'false'
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.latest }}
          release_name: "OpenCV MinGW Build ${{ steps.get_tag.outputs.latest }}"
          body: |
            This is an automated OpenCV MinGW build for Windows.

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}

      - name: Upload to Release
        if: steps.check_release.outputs.skip == 'false'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: build_opencv/opencv-mingw.zip
          asset_name: opencv-mingw-${{ steps.get_tag.outputs.latest }}.zip
          asset_content_type: application/zip
